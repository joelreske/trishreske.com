---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('posts');
const sortedPosts = allPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Prepare search data with content for client-side search
const searchData = sortedPosts.map(post => {
  const content = post.body || '';
  // Strip markdown for cleaner text search
  const plainContent = content
    .replace(/^#+\s+.*$/gm, '')
    .replace(/!\[.*?\]\(.*?\)/g, '')
    .replace(/\[([^\]]*)\]\([^)]*\)/g, '$1')
    .replace(/\*{1,2}([^*]*)\*{1,2}/g, '$1')
    .replace(/_{1,2}([^_]*)_{1,2}/g, '$1')
    .replace(/\*+/g, '')
    .replace(/_+/g, ' ')
    .replace(/\n+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();

  return {
    title: post.data.title,
    slug: post.id.replace(/\.md$/, ''),
    date: post.data.date.toISOString(),
    categories: post.data.categories || [],
    content: plainContent,
  };
});
---

<BaseLayout title="Search - Trish Reske's StoryLines Blog">
  <div id="content">
    <article class="post-card">
      <h1 class="text-2xl font-serif text-[#600] mb-4">Search Articles</h1>

      <div class="mb-6">
        <input
          type="text"
          id="search-input"
          placeholder="Search articles..."
          class="w-full p-3 border border-gray-300 rounded text-base focus:outline-none focus:border-[#900]"
          autofocus
        />
      </div>

      <div id="search-results">
        <p class="text-gray-500 italic">Enter a search term to find articles.</p>
      </div>
    </article>
  </div>
</BaseLayout>

<script define:vars={{ searchData }}>
  const posts = searchData;
  const searchInput = document.getElementById('search-input');
  const resultsContainer = document.getElementById('search-results');

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function highlightMatch(text, query) {
    if (!query) return escapeHtml(text);
    const escaped = escapeHtml(text);
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return escaped.replace(regex, '<mark class="bg-yellow-200">$1</mark>');
  }

  function getSnippet(content, query, maxLength = 200) {
    const lowerContent = content.toLowerCase();
    const lowerQuery = query.toLowerCase();
    const index = lowerContent.indexOf(lowerQuery);

    if (index === -1) {
      // No match in content, return start
      return content.substring(0, maxLength) + (content.length > maxLength ? '...' : '');
    }

    // Find a good starting point (start of sentence or some chars before)
    let start = Math.max(0, index - 60);
    let end = Math.min(content.length, index + query.length + 140);

    // Adjust to word boundaries
    if (start > 0) {
      const spaceIndex = content.indexOf(' ', start);
      if (spaceIndex !== -1 && spaceIndex < index) {
        start = spaceIndex + 1;
      }
    }

    if (end < content.length) {
      const spaceIndex = content.lastIndexOf(' ', end);
      if (spaceIndex > index + query.length) {
        end = spaceIndex;
      }
    }

    let snippet = content.substring(start, end);
    if (start > 0) snippet = '...' + snippet;
    if (end < content.length) snippet = snippet + '...';

    return snippet;
  }

  function search(query) {
    if (!query || query.length < 2) {
      resultsContainer.innerHTML = '<p class="text-gray-500 italic">Enter at least 2 characters to search.</p>';
      return;
    }

    const lowerQuery = query.toLowerCase();
    const results = posts.filter(post => {
      return (
        post.title.toLowerCase().includes(lowerQuery) ||
        post.content.toLowerCase().includes(lowerQuery) ||
        post.categories.some(cat => cat.toLowerCase().includes(lowerQuery))
      );
    });

    if (results.length === 0) {
      resultsContainer.innerHTML = `<p class="text-gray-500 italic">No articles found for "${escapeHtml(query)}".</p>`;
      return;
    }

    const html = results.map(post => {
      const snippet = getSnippet(post.content, query);
      const highlightedTitle = highlightMatch(post.title, query);
      const highlightedSnippet = highlightMatch(snippet, query);

      return `
        <div class="mb-6 pb-6 border-b border-gray-200 last:border-b-0">
          <h2 class="text-lg font-serif mb-1">
            <a href="/posts/${post.slug}" class="text-[#900] hover:text-[#600] no-underline">
              ${highlightedTitle}
            </a>
          </h2>
          <p class="text-sm text-gray-500 italic mb-2">${formatDate(post.date)}</p>
          <p class="text-gray-700 text-sm leading-relaxed">${highlightedSnippet}</p>
        </div>
      `;
    }).join('');

    resultsContainer.innerHTML = `
      <p class="text-gray-600 mb-4">${results.length} article${results.length === 1 ? '' : 's'} found</p>
      ${html}
    `;
  }

  // Debounce search
  let timeout;
  searchInput.addEventListener('input', (e) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => search(e.target.value.trim()), 200);
  });

  // Handle initial URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get('q');
  if (initialQuery) {
    searchInput.value = initialQuery;
    search(initialQuery);
  }
</script>
